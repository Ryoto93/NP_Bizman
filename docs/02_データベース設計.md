# データベース設計書

## 概要

本プロジェクトでは、**Supabase**をBaaSとして使用し、PostgreSQLデータベースを提供します。
Supabaseの設計については、MCPサーバーで自動化するため、[Supabase設計準備ガイド](./05_Supabase設計準備ガイド.md)を参照して準備作業を完了してください。

本ドキュメントは**Prismaスキーマ**に基づいた設計書です。Supabaseでの実装時には、この設計をベースにMCPサーバーでテーブル構造を構築します。

## ER図の概要

### 主要エンティティ
1. **事業 (Business)** - 事業マスター
2. **商材 (Product)** - 商材マスター
3. **案件ステータス (DealStatus)** - 案件ステータスマスター
4. **顧客 (Customer)** - 顧客マスター
5. **案件 (Deal)** - 案件情報
6. **事業計画 (BusinessPlan)** - 事業の計画と実績
7. **KPI (KPI)** - KPI定義
8. **売上ロジック (RevenueLogic)** - 売上計算ロジック
9. **KPI計画 (KPIPlan)** - KPIの計画値
10. **KPI実績 (KPIResult)** - KPIの実績値
11. **事業コスト項目 (BusinessCostItem)** - 事業コスト項目マスター
12. **事業コスト計画 (BusinessCostPlan)** - 事業コストの計画値
13. **事業コスト実績 (BusinessCostResult)** - 事業コストの実績値
14. **人員 (Person)** - 人員情報（By Name）
15. **全社コスト項目 (CorporateCostItem)** - 全社コスト項目マスター
16. **全社コスト計画 (CorporateCostPlan)** - 全社コストの計画値
17. **全社コスト実績 (CorporateCostResult)** - 全社コストの実績値
18. **シナリオ (Scenario)** - シナリオマスター（Better/Bad）
19. **ユーザー (User)** - ユーザー情報（Supabase Auth連携）

## 詳細スキーマ

### シナリオ (Scenario)

事業計画・コーポレート計画・人員計画などの「計画値」「最新見込み値」を束ねるためのシナリオマスタ。

```prisma
enum ScenarioCategory {
  PLAN     // 予算（Bad / Better / Best など）
  FORECAST // 最新見込み（Latest Forecast など）
}

model Scenario {
  id                 String              @id @default(uuid())
  name               String              // 画面表示名（例: "Betterケース", "最新見込み"）
  code               String              @unique // システム内で一意なコード（例: "PLAN_BETTER", "FORECAST_LATEST"）
  category           ScenarioCategory    @default(PLAN) // 予算か最新見込みか
  isDefault          Boolean             @default(false) // デフォルト表示のシナリオかどうか
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
}
```

### 事業 (Business)
```prisma
model Business {
  id        String   @id @default(uuid())
  name      String   // 例: "SaaS事業"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  plans           BusinessPlan[]
  costItems       BusinessCostItem[]
  deals           Deal[]
}
```

### 商材 (Product)
```prisma
model Product {
  id        String   @id @default(uuid())
  name      String   // 例: "SaaS - Proプラン"
  businessId String?
  business  Business? @relation(fields: [businessId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  deals     Deal[]
}
```

### 案件ステータス (DealStatus)
```prisma
model DealStatus {
  id        String   @id @default(uuid())
  name      String   // 例: "リード", "商談中", "受注", "失注"
  order     Int      // 表示順序
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  deals     Deal[]
}
```

### 顧客 (Customer)
```prisma
model Customer {
  id           String   @id @default(uuid())
  name         String   // 顧客名
  contactPerson String? // 担当者
  email        String?
  phone        String?
  address      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  deals        Deal[]
}
```

### 案件 (Deal)
```prisma
model Deal {
  id            String   @id @default(uuid())
  name          String   // 案件名
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  productId     String?
  product       Product? @relation(fields: [productId], references: [id])
  statusId      String
  status        DealStatus @relation(fields: [statusId], references: [id])
  expectedMonth Int      // 受注(予定)月 (1-12)
  expectedYear  Int      // 受注(予定)年
  expectedAmount Decimal  // 受注(予定)額
  assignedUserId String? // 担当者
  activityHistory Json?  // 活動履歴
  businessId    String?
  business      Business? @relation(fields: [businessId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
```

### KPI (KPI)
```prisma
model KPI {
  id          String   @id @default(uuid())
  businessId  String
  business    Business @relation(fields: [businessId], references: [id])
  name        String   // KPI名 (例: "顧客数")
  unit        String?  // 単位
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  plans       KPIPlan[]
  results     KPIResult[]
  revenueLogicEntries RevenueLogicEntry[]
}
```

### 売上ロジック (RevenueLogic)
```prisma
model RevenueLogic {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  formula    String   // 計算式 (例: "KPI_顧客数 * KPI_単価")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  entries    RevenueLogicEntry[]
}

model RevenueLogicEntry {
  id             String        @id @default(uuid())
  revenueLogicId String
  revenueLogic   RevenueLogic  @relation(fields: [revenueLogicId], references: [id])
  kpiId          String?
  kpi            KPI?          @relation(fields: [kpiId], references: [id])
  coefficient    Decimal       // 係数（掛け算の場合）
  operator       String        // 演算子 ("*", "+", "-", "/")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}
```

### 事業計画 (BusinessPlan)
```prisma
model BusinessPlan {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  scenarioId String
  scenario   Scenario @relation(fields: [scenarioId], references: [id])
  fiscalYear Int      // 会計年度
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  kpiPlans           KPIPlan[]
  costPlans          BusinessCostPlan[]
  revenueResults     RevenueResult[]
  costResults        BusinessCostResult[]
  salesPlans         SalesPlan[]      // 商材別売上計画
}
```

### 商材別売上計画 (SalesPlan)

事業計画 × 商材 × 月ごとの売上計画金額を保持するテーブル。  
「事業計画（Bad/Better/Best/最新見込み）」ごとの商材別売上計画 UI で利用する。

```prisma
model SalesPlan {
  id             String       @id @default(uuid())
  businessPlanId String
  productId      String
  month          Int          // 1-12（会計年度上は 10月〜翌9月を UI で並び替え）
  amount         Decimal      @db.Decimal(15, 2) // 計画金額
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  businessPlan   BusinessPlan @relation(fields: [businessPlanId], references: [id], onDelete: Cascade)
  product        Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([businessPlanId, productId, month])
  @@index([businessPlanId])
  @@index([productId])
  @@index([month])
}
```

### KPI計画 (KPIPlan)
```prisma
model KPIPlan {
  id            String        @id @default(uuid())
  businessPlanId String
  businessPlan   BusinessPlan @relation(fields: [businessPlanId], references: [id])
  kpiId          String
  kpi            KPI          @relation(fields: [kpiId], references: [id])
  month          Int          // 1-12
  value          Decimal       // 計画値
  notes          String?       // メモ
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  @@unique([businessPlanId, kpiId, month])
}
```

### KPI実績 (KPIResult)
```prisma
model KPIResult {
  id       String   @id @default(uuid())
  kpiId    String
  kpi      KPI      @relation(fields: [kpiId], references: [id])
  month    Int      // 1-12
  year     Int      // 年
  value    Decimal  // 実績値
  notes    String?  // メモ
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([kpiId, month, year])
}
```

### 売上実績 (RevenueResult)
```prisma
model RevenueResult {
  id            String        @id @default(uuid())
  businessPlanId String
  businessPlan   BusinessPlan @relation(fields: [businessPlanId], references: [id])
  month          Int          // 1-12
  value          Decimal      // 売上実績値
  notes          String?      // メモ（自動で "[顧客名] / [案件名]" が入る）
  dealId         String?      // 案件ID（CRM連携用）
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@unique([businessPlanId, month])
}
```

### 事業コスト項目 (BusinessCostItem)
```prisma
model BusinessCostItem {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  name       String   // コスト項目名
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  plans      BusinessCostPlan[]
  results    BusinessCostResult[]
}
```

### 事業コスト計画 (BusinessCostPlan)
```prisma
model BusinessCostPlan {
  id               String            @id @default(uuid())
  businessPlanId   String
  businessPlan     BusinessPlan      @relation(fields: [businessPlanId], references: [id])
  costItemId       String
  costItem         BusinessCostItem  @relation(fields: [costItemId], references: [id])
  month             Int               // 1-12
  value             Decimal           // 計画値
  notes             String?           // メモ
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@unique([businessPlanId, costItemId, month])
}
```

### 事業コスト実績 (BusinessCostResult)
```prisma
model BusinessCostResult {
  id               String            @id @default(uuid())
  businessPlanId   String
  businessPlan     BusinessPlan      @relation(fields: [businessPlanId], references: [id])
  costItemId       String
  costItem         BusinessCostItem  @relation(fields: [costItemId], references: [id])
  month             Int               // 1-12
  value             Decimal           // 実績値
  notes             String?           // メモ
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@unique([businessPlanId, costItemId, month])
}
```

### 人員 (Person)
```prisma
model Person {
  id              String   @id @default(uuid())
  name            String   // 氏名（TBDの場合は "TBD"）
  contractType    String   // 契約形態（正社員、契約社員、業務委託等）
  unitPrice       Decimal  // 単価（月額）
  startMonth      Int      // 在籍開始月
  startYear       Int      // 在籍開始年
  endMonth        Int?     // 在籍終了月（nullの場合は継続）
  endYear         Int?     // 在籍終了年（nullの場合は継続）
  businessId      String?  // 担当事業
  business        Business? @relation(fields: [businessId], references: [id])
  scenarioId      String
  scenario        Scenario @relation(fields: [scenarioId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
```

### 全社コスト項目 (CorporateCostItem)
```prisma
model CorporateCostItem {
  id        String   @id @default(uuid())
  name      String   // コスト項目名
  isAuto    Boolean  @default(false) // 自動計算項目かどうか
  // isAuto=true の場合: "人件費", "法定福利費", "業務委託費"
  // isAuto=false の場合: "家賃", "通信費" など手動入力
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  plans     CorporateCostPlan[]
  results   CorporateCostResult[]
}
```

### 全社コスト計画 (CorporateCostPlan)
```prisma
model CorporateCostPlan {
  id               String              @id @default(uuid())
  costItemId       String
  costItem         CorporateCostItem   @relation(fields: [costItemId], references: [id])
  scenarioId       String
  scenario         Scenario            @relation(fields: [scenarioId], references: [id])
  month             Int                 // 1-12
  year              Int                 // 年
  value             Decimal             // 計画値（自動計算の場合は計算結果）
  notes             String?             // メモ
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@unique([costItemId, scenarioId, month, year])
}
```

### 全社コスト実績 (CorporateCostResult)
```prisma
model CorporateCostResult {
  id               String              @id @default(uuid())
  costItemId       String
  costItem         CorporateCostItem   @relation(fields: [costItemId], references: [id])
  month             Int                 // 1-12
  year              Int                 // 年
  value             Decimal             // 実績値
  notes             String?             // メモ
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@unique([costItemId, month, year])
}
```

### ユーザー (User)
```prisma
// Supabase Authと連携するため、auth.users テーブルを使用
// 必要に応じて拡張情報を保存するテーブルを作成
model UserProfile {
  id        String   @id @default(uuid())
  userId    String   @unique // Supabase Auth のユーザーID
  name      String?
  email     String?
  role      String?  // 役割（オプション）
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

## インデックスと制約

### 重要なインデックス
- 各年月での検索を高速化するため、month, year にインデックスを設定
- businessId, scenarioId, customerId などの外部キーにインデックスを設定
- 一意制約を適切に設定（同じ月・年・事業・シナリオの重複を防止）

## 初期データ

### 必須マスターデータ
1. **シナリオ**
   - Betterケース（code: `PLAN_BETTER`, category: PLAN）
   - Badケース（code: `PLAN_BAD`, category: PLAN）
   - Bestケース（code: `PLAN_BEST`, category: PLAN）
   - 最新見込み（Latest Forecast）（code: `FORECAST_LATEST`, category: FORECAST, isDefault: true）

2. **案件ステータス**（初期値）
   - リード
   - 商談中
   - 受注
   - 失注

3. **全社コスト項目**（自動計算項目）
   - 人件費（isAuto=true）
   - 法定福利費（isAuto=true）
   - 業務委託費（isAuto=true）

